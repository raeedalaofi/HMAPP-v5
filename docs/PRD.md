# HMAPP v5.0 - Product Requirements Document (PRD)
# وثيقة متطلبات المنتج

---

## 1. نظرة عامة (Overview)

### 1.1 وصف المنتج
**HMAPP** هو تطبيق سوق خدمات حرفية (Handyman Marketplace) يربط العملاء بالفنيين المهرة التابعين لشركات الصيانة. يعمل بنموذج "الفني كموظف" حيث يجب أن ينتمي كل فني لشركة مسجلة.

### 1.2 الرؤية
إنشاء منصة موثوقة وسريعة لخدمات الصيانة المنزلية في المملكة العربية السعودية، مع ضمان جودة الخدمة من خلال نظام الشركات والتقييم المتبادل.

### 1.3 الأهداف الرئيسية
- ربط العملاء بالفنيين القريبين خلال دقائق
- ضمان جودة الخدمة عبر نظام الشركات والتقييمات
- توفير نظام دفع آمن وسريع
- تمكين الشركات من إدارة فنييها بكفاءة

---

## 2. المستخدمون (User Personas)

### 2.1 العميل (Customer)
- **الوصف**: شخص يحتاج خدمة صيانة منزلية
- **الأهداف**: 
  - طلب خدمة بسرعة وسهولة
  - الحصول على عروض أسعار متعددة
  - اختيار الفني الأنسب بناءً على التقييم والسعر
  - الدفع الآمن
  - تقييم الخدمة

### 2.2 الفني (Technician)
- **الوصف**: حرفي ماهر تابع لشركة صيانة
- **الأهداف**:
  - استقبال طلبات في منطقته
  - تقديم عروض أسعار
  - إكمال الأعمال وكسب المال
  - بناء سمعة جيدة

### 2.3 مدير الشركة (Company Owner)
- **الوصف**: صاحب أو مدير شركة صيانة
- **الأهداف**:
  - إدارة فريق الفنيين
  - متابعة الأداء والإيرادات
  - سحب الأرباح
  - تنمية الأعمال

### 2.4 المسؤول (Admin)
- **الوصف**: مشرف على المنصة
- **الأهداف**:
  - مراقبة جودة الخدمة
  - حل النزاعات
  - إدارة الفئات والإعدادات

---

## 3. الميزات الأساسية (Core Features)

### 3.1 نظام المصادقة والتسجيل

#### التسجيل
| النوع | المتطلبات | التحقق |
|-------|----------|--------|
| عميل | الاسم، الجوال/البريد | رمز OTP |
| فني | الاسم، الجوال، معرف الشركة | OTP + موافقة الشركة |
| شركة | الاسم، بيانات المالك، السجل التجاري | OTP + مراجعة يدوية |

#### المصادقة
- تسجيل دخول بالجوال + OTP
- تسجيل دخول بالبريد + كلمة المرور
- تسجيل دخول اجتماعي (Google, Apple) - اختياري
- JWT tokens عبر Supabase Auth

### 3.2 الملفات الشخصية (Profiles)

#### بروفايل العميل
```
- الصورة الشخصية
- الاسم الكامل
- رقم الجوال (موثق)
- البريد الإلكتروني
- العناوين المحفوظة
- التقييم (من الفنيين)
- إحصائيات (عدد الطلبات، المبلغ المصروف)
- رصيد المكافآت
```

#### بروفايل الفني
```
- الصورة الشخصية
- الاسم الكامل
- رقم الجوال
- الشركة التابع لها
- التخصص
- سنوات الخبرة
- المهارات/الفئات
- التقييم (من العملاء)
- عدد الأعمال المنجزة
- حالة التوفر (متصل/غير متصل)
- الموقع الحالي
```

#### بروفايل الشركة
```
- الشعار
- اسم الشركة
- الوصف
- رقم السجل التجاري
- معلومات الاتصال
- العنوان
- الحساب البنكي (IBAN)
- عدد الفنيين
- التقييم العام
- إجمالي الإيرادات
```

### 3.3 نظام الطلبات (Jobs)

#### دورة حياة الطلب
```
1. draft (مسودة)
      ↓
2. waiting_for_offers (انتظار العروض - 5 دقائق)
      ↓
   ├→ offers_expired (لم تصل عروض)
   │
   └→ assigned (تم اختيار عرض)
         ↓
      payment_pending (انتظار الدفع - 5 دقائق)
         ↓
      ├→ payment_expired (انتهى وقت الدفع)
      │
      └→ in_progress (جاري التنفيذ)
            ↓
         completed (مكتمل)
```

#### إنشاء الطلب
1. اختيار فئة الخدمة
2. تحديد العنوان (من المحفوظ أو جديد)
3. كتابة العنوان والوصف
4. إرفاق صور (اختياري)
5. تحديد الموعد المفضل (اختياري)
6. النشر

#### نافذة العروض (5 دقائق)
- إشعار للفنيين القريبين (2 كم)
- الفني يرى تفاصيل الطلب
- الفني يقدم عرضه (السعر + رسالة)
- العميل يرى العروض في الوقت الفعلي
- العميل يختار العرض الأفضل

### 3.4 نظام الموقع الجغرافي

#### تحديد موقع العميل
- GPS تلقائي
- اختيار من الخريطة
- إدخال يدوي
- حفظ عناوين متعددة (المنزل، العمل، إلخ)

#### تتبع موقع الفني
- تحديث تلقائي أثناء الاتصال
- البحث عن طلبات قريبة
- نطاق الخدمة (قابل للتعديل)

#### إشعارات النطاق
- عند نشر طلب جديد
- البحث في دائرة 2 كم
- إشعار push للفنيين المؤهلين والمتصلين

### 3.5 نظام التقييم المتبادل

#### تقييم العميل للفني (بعد الإكمال)
```
- التقييم العام (1-5 نجوم) *إجباري
- جودة العمل (1-5)
- الالتزام بالوقت (1-5)
- السلوك والتعامل (1-5)
- مناسبة السعر (1-5)
- تعليق نصي
- صور (اختياري)
```

#### تقييم الفني للعميل (بعد الإكمال)
```
- التقييم العام (1-5 نجوم) *إجباري
- التواصل (1-5)
- دقة العنوان (1-5)
- الدفع (1-5)
- تعليق نصي
```

#### ردود التقييمات
- الفني يمكنه الرد على تقييم العميل
- الرد مرة واحدة فقط

### 3.6 نظام الدفع

#### طرق الدفع
- بطاقة ائتمان/خصم
- Apple Pay
- مدى
- STC Pay (مستقبلي)

#### رابط الدفع
- صلاحية 5 دقائق
- Token فريد
- تكامل مع Payment Gateway

#### المكافآت والخصومات
- 100 ريال رصيد ترحيبي
- 25 ريال خصم لكل طلب (4 مرات)
- خصم تلقائي عند الدفع

### 3.7 نظام Batch للشركات

#### كيف يعمل
1. الشركة تحدد حجم الـ Batch (مثلاً 5 طلبات)
2. كل فني له Batch نشط
3. عند إكمال كل طلب، يُضاف للـ Batch
4. عند اكتمال الـ Batch، يصبح جاهزاً للسحب
5. مدير الشركة يسحب الأرباح
6. يبدأ Batch جديد تلقائياً

#### الحسابات
```
إجمالي الطلب = سعر العرض
نصيب الشركة = 15% من الإجمالي
المبلغ للسحب = مجموع نصيب الشركة في الـ Batch
```

### 3.8 نظام الإشعارات

#### أنواع الإشعارات
| النوع | المستلم | المحتوى |
|-------|---------|---------|
| new_job_nearby | الفني | طلب جديد في منطقتك |
| offer_received | العميل | عرض جديد على طلبك |
| offer_accepted | الفني | تم قبول عرضك |
| offer_rejected | الفني | تم رفض عرضك |
| payment_received | الفني | تم الدفع، ابدأ العمل |
| job_completed | العميل | اكتمل طلبك، قيّم الآن |
| new_review | الفني/العميل | تقييم جديد |
| system_alert | الكل | تنبيهات النظام |

#### قنوات الإرسال
- Push Notifications (Firebase/APNs)
- In-App Notifications
- SMS (اختياري)
- Email (اختياري)

---

## 4. المتطلبات التقنية (Technical Requirements)

### 4.1 Stack التقني

#### Frontend (Mobile)
```
Framework: React Native / Flutter
State Management: Redux / Riverpod
Maps: Google Maps SDK
Push: Firebase Cloud Messaging
```

#### Frontend (Web - Dashboard)
```
Framework: Next.js 14+
UI: Tailwind CSS + shadcn/ui
State: React Query / Zustand
Charts: Recharts
```

#### Backend
```
Platform: Supabase
Database: PostgreSQL 15+
Auth: Supabase Auth
Storage: Supabase Storage
Realtime: Supabase Realtime
Functions: Edge Functions (Deno)
```

#### الإضافات المطلوبة
```sql
- pgcrypto (تشفير)
- postgis (الموقع الجغرافي)
- pg_trgm (البحث النصي)
```

### 4.2 بنية قاعدة البيانات

#### الجداول الأساسية (28 جدول)
```
المستخدمون:
- user_profiles
- customers
- companies
- technicians
- user_devices
- verification_codes
- admin_users

الخدمات:
- service_categories
- technician_skills
- technician_availability
- service_areas
- customer_addresses

الطلبات:
- jobs
- job_photos
- price_offers
- payment_links

المالية:
- company_batches
- wallets
- wallet_transactions

التقييمات:
- job_reviews
- customer_reviews

التواصل:
- messages
- notifications

النظام:
- event_logs
- abuse_reports
- system_settings
- faqs
- promotions
```

### 4.3 الأمان

#### Row Level Security (RLS)
- مفعّل على جميع الجداول
- سياسات حسب الدور
- حماية البيانات الحساسة

#### التحقق
- OTP للجوال (6 أرقام، 10 دقائق)
- تحقق البريد الإلكتروني
- Rate Limiting (5 محاولات/ساعة)

#### التشفير
- كلمات المرور: bcrypt
- البيانات الحساسة: pgcrypto
- HTTPS فقط

### 4.4 الأداء

#### الفهارس
- فهارس على جميع Foreign Keys
- فهارس مركبة للاستعلامات الشائعة
- فهارس GIST للموقع الجغرافي
- فهارس GIN للبحث النصي

#### التحسينات
- Connection Pooling
- Query Caching
- Pagination
- Lazy Loading

---

## 5. واجهات المستخدم (UI/UX)

### 5.1 تطبيق العميل

#### الشاشات الرئيسية
```
1. Splash Screen
2. Onboarding (3 شاشات)
3. Login / Register
4. Home (الفئات + آخر الطلبات)
5. Category Details
6. Create Job
7. Job Details (مع العروض)
8. Payment
9. Active Job (تتبع)
10. Job Complete (تقييم)
11. My Jobs (التاريخ)
12. Profile
13. Addresses
14. Wallet
15. Notifications
16. Settings
17. Support
```

### 5.2 تطبيق الفني

#### الشاشات الرئيسية
```
1. Login / Register
2. Pending Approval Screen
3. Home (الطلبات القريبة)
4. Job Details
5. Submit Offer
6. My Jobs (النشطة والمكتملة)
7. Active Job (مع الخريطة)
8. Complete Job
9. Profile
10. My Reviews
11. Availability Settings
12. Notifications
13. Settings
```

### 5.3 لوحة تحكم الشركة (Web)

#### الأقسام
```
1. Dashboard (نظرة عامة)
2. Technicians (إدارة الفنيين)
3. Jobs (الطلبات)
4. Batches (دورات السحب)
5. Wallet (المحفظة)
6. Reviews (التقييمات)
7. Reports (التقارير)
8. Settings (الإعدادات)
```

### 5.4 لوحة تحكم المسؤول (Web)

#### الأقسام
```
1. Dashboard
2. Users (عملاء، فنيين، شركات)
3. Jobs
4. Categories
5. Reviews & Reports
6. Payments
7. Settings
8. Logs
```

---

## 6. التكاملات (Integrations)

### 6.1 Payment Gateway
- **المزود**: [Moyasar / Tap / HyperPay]
- **الميزات**: بطاقات، Apple Pay، مدى

### 6.2 Push Notifications
- **المزود**: Firebase Cloud Messaging
- **iOS**: APNs

### 6.3 SMS Gateway
- **المزود**: [Unifonic / Twilio]
- **الاستخدام**: OTP

### 6.4 Maps
- **المزود**: Google Maps Platform
- **APIs**: Maps SDK, Geocoding, Places

### 6.5 Analytics
- **المزود**: Firebase Analytics / Mixpanel
- **التتبع**: أحداث المستخدم، التحويلات

---

## 7. مراحل التطوير (Development Phases)

### Phase 1: MVP (8-10 أسابيع)
```
الأسبوع 1-2:
- Setup المشروع
- قاعدة البيانات
- Auth الأساسي

الأسبوع 3-4:
- تسجيل العملاء والفنيين
- الملفات الشخصية
- العناوين

الأسبوع 5-6:
- إنشاء الطلبات
- نظام العروض
- الإشعارات الأساسية

الأسبوع 7-8:
- الدفع
- إكمال الطلب
- التقييمات

الأسبوع 9-10:
- الاختبار
- Bug Fixes
- الإطلاق التجريبي
```

### Phase 2: Enhancement (4-6 أسابيع)
```
- لوحة تحكم الشركات
- نظام Batch
- تقارير متقدمة
- تحسينات الأداء
```

### Phase 3: Scale (4-6 أسابيع)
```
- لوحة تحكم المسؤول
- Analytics
- Multi-language
- تحسينات UX
```

---

## 8. مقاييس النجاح (Success Metrics)

### KPIs الأساسية
| المقياس | الهدف (3 أشهر) | الهدف (سنة) |
|---------|---------------|-------------|
| المستخدمون النشطون | 1,000 | 10,000 |
| الطلبات الشهرية | 500 | 5,000 |
| معدل إكمال الطلبات | 80% | 90% |
| متوسط التقييم | 4.0 | 4.5 |
| زمن استجابة العروض | < 3 دقائق | < 2 دقائق |

---

## 9. المخاطر والتخفيف (Risks & Mitigation)

| المخاطر | الاحتمال | التأثير | التخفيف |
|---------|---------|---------|---------|
| قلة الفنيين | متوسط | عالي | شراكات مع شركات صيانة |
| مشاكل الدفع | منخفض | عالي | اختبار مكثف، دعم فني |
| تقييمات سلبية | متوسط | متوسط | نظام حل النزاعات |
| أداء ضعيف | منخفض | متوسط | تحسين مستمر، مراقبة |

---

## 10. الملاحق

### 10.1 Glossary
- **Batch**: دورة عمل للفني تحتوي عدد محدد من الطلبات
- **Offer Window**: نافذة 5 دقائق لتلقي العروض
- **Payment Link**: رابط دفع بصلاحية 5 دقائق

### 10.2 المراجع
- Supabase Documentation
- PostGIS Documentation
- React Native Documentation

---

**تاريخ الإنشاء**: 2025
**الإصدار**: 5.0
**المؤلف**: HMAPP Team